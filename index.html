<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clair Mat - Pr√©cisions</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    form, table, .filters, .export-buttons {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    form input, form select, form button {
      margin: 5px 0;
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    table th, table td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    .actions button {
      margin-right: 5px;
    }
    .filters, .export-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .filters input {
      flex: 1;
    }
  </style>
</head>
<body>

  <h1>Clair Mat - Pr√©cisions</h1>

  <form id="precisionForm">
    <label>Date :</label>
    <input type="date" id="date" required />
    
    <label>Pr√©cision :</label>
    <input type="text" id="precision" required />
    
    <label>√âtat :</label>
    <select id="etat">
      <option value="√Ä faire">√Ä faire</option>
      <option value="En cours">En cours</option>
      <option value="Fait">Fait</option>
    </select>

    <button type="submit">Ajouter</button>
  </form>

  <div class="filters">
    <select id="etatFilter">
      <option value="">Tous les √©tats</option>
      <option value="√Ä faire">√Ä faire</option>
      <option value="En cours">En cours</option>
      <option value="Fait">Fait</option>
    </select>
    <input type="text" id="search" placeholder="Rechercher une pr√©cision..." />
  </div>

  <table>
    <thead>
      <tr>
        <th onclick="sortTable('date')">Date üìÖ</th>
        <th>Pr√©cision</th>
        <th onclick="sortTable('etat')">√âtat üè∑Ô∏è</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="precisionTableBody"></tbody>
  </table>

  <div class="export-buttons">
    <button onclick="exportData()">üì§ Exporter JSON</button>
    <input type="file" accept=".json" onchange="importData(event)" />
  </div>

  <script>
    let precisions = JSON.parse(localStorage.getItem("precisions") || "[]");
    let archived = JSON.parse(localStorage.getItem("archives") || "[]");
    let currentSort = { key: 'date', asc: true };

    const form = document.getElementById("precisionForm");
    const tableBody = document.getElementById("precisionTableBody");
    const searchInput = document.getElementById("search");
    const etatFilter = document.getElementById("etatFilter");

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const date = document.getElementById("date").value;
      const text = document.getElementById("precision").value.trim();
      const etat = document.getElementById("etat").value;

      if (!date || !text) return;

      precisions.push({ date, text, etat });
      save();
      form.reset();
    });

    function renderTable() {
      const keyword = searchInput.value.toLowerCase();
      const etat = etatFilter.value;

      const filtered = precisions.filter(p => 
        (!etat || p.etat === etat) &&
        (!keyword || p.text.toLowerCase().includes(keyword))
      );

      const sorted = filtered.sort((a, b) => {
        let valA = a[currentSort.key];
        let valB = b[currentSort.key];
        return currentSort.asc 
          ? valA.localeCompare(valB) 
          : valB.localeCompare(valA);
      });

      tableBody.innerHTML = sorted.map((p, i) => `
        <tr>
          <td>${p.date}</td>
          <td>${p.text}</td>
          <td>${p.etat}</td>
          <td class="actions">
            <button onclick="archive(${i})">Archiver</button>
            <button onclick="remove(${i})">Supprimer</button>
          </td>
        </tr>
      `).join("");
    }

    function archive(index) {
      archived.push(precisions[index]);
      precisions.splice(index, 1);
      save();
    }

    function remove(index) {
      if (confirm("Supprimer cette pr√©cision ?")) {
        precisions.splice(index, 1);
        save();
      }
    }

    function save() {
      localStorage.setItem("precisions", JSON.stringify(precisions));
      localStorage.setItem("archives", JSON.stringify(archived));
      renderTable();
    }

    function sortTable(key) {
      if (currentSort.key === key) currentSort.asc = !currentSort.asc;
      else {
        currentSort.key = key;
        currentSort.asc = true;
      }
      renderTable();
    }

    function exportData() {
      const data = {
        precisions,
        archived
      };
      const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "clairmat-donnees.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (data.precisions && data.archived) {
            precisions = data.precisions;
            archived = data.archived;
            save();
          } else {
            alert("Fichier invalide");
          }
        } catch {
          alert("Erreur de lecture du fichier");
        }
      };
      reader.readAsText(file);
    }

    searchInput.addEventListener("input", renderTable);
    etatFilter.addEventListener("change", renderTable);

    renderTable();
  </script>

</body>
</html>
